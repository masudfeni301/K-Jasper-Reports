SELECT
EMP_ID,
NAME,
DESIGNATION,
SECTION_NAME,
JOIN_DATE,
GRADE,
ROUND(PBASIC_SALARY) PBASIC_SALARY,
PHOUSE_RENT,
PMEDICAL_ALL,
PCONVEYANCE_ALL,
FOOD_ALL,
GROSS_SAL,
WEEK_GOV_HOLIDAY,
CASUAL_LEAVE, 
EARN_LEAVE, 
MEDICAL_LEAVE,
OTHERS_LEAVE,
EL_PLUS_CL,
TOTAL_WORKING_DAYS,
TOTAL_PAYABLE_DAYS,
CF_PF,
ROUND(OT_RATE,2) OT_RATE,
OT_HOUR,
MONTH_DAYS,
ROUND((NVL(PBASIC_SALARY,0)/30)*NVL(TOTAL_ABSENT, 0),2) AS ABSENT_DEDUCT_AMT,
NVL(CF_PF,0)+NVL(ROUND((NVL(PBASIC_SALARY,0)/30)*NVL(TOTAL_ABSENT, 0),2),0) AS TOTAL_DEDUCT_AMT,
ROUND(((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0))*NVL(TOTAL_PAYABLE_DAYS,0))+((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0)*NVL(TOTAL_ABSENT,0)) - NVL(ROUND((NVL(PBASIC_SALARY,0)/30)*NVL(TOTAL_ABSENT, 0),2),0)), 2) AS PAYABLE_AMT,
NVL(ROUND(((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0))*NVL(TOTAL_PAYABLE_DAYS,0))+((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0)*NVL(TOTAL_ABSENT,0)) - NVL(ROUND((NVL(PBASIC_SALARY,0)/30)*NVL(TOTAL_ABSENT, 0),2),0)), 2),0)-NVL(CF_PF,0) AS NET_PAYABLE_AMOUNT,
ROUND(NVL(OT_RATE,0)*NVL(OT_HOUR,0)) AS OT_AMT,
NVL(NVL(ROUND(((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0))*NVL(TOTAL_PAYABLE_DAYS,0))+((NVL(GROSS_SAL,0)/NVL(MONTH_DAYS,0)*NVL(TOTAL_ABSENT,0)) - NVL(ROUND((NVL(PBASIC_SALARY,0)/30)*NVL(TOTAL_ABSENT, 0),2),0)), 2),0)-NVL(CF_PF,0),0)+NVL(ROUND(NVL(OT_RATE,0)*NVL(OT_HOUR,0)),0) AS TOT_PAYABLE_AMT
FROM (SELECT
EMP_ID,
NAME,
DESIGNATION,
SECTION_NAME,
JOIN_DT JOIN_DATE,
GRADE,
PBASIC_SALARY,
PHOUSE_RENT,
PMEDICAL_ALL,
PCONVEYANCE_ALL,
FOOD_ALL,
GROSS_SAL,
NVL(WEEKLY_HOLIDAY,0)+NVL(GOV_HOLIDAY,0) AS WEEK_GOV_HOLIDAY,
CASUAL_LEAVE, 
EARN_LEAVE, 
MEDICAL_LEAVE,
OTHERS_LEAVE,
NVL(EARN_LEAVE,0)+NVL(CASUAL_LEAVE,0) AS EL_PLUS_CL,
NVL(CASUAL_LEAVE,0)+NVL(MEDICAL_LEAVE,0)+NVL(EARN_LEAVE,0)+NVL(OTHERS_LEAVE,0) AS TOTAL_LEAVE_DAY,
NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0) AS TOTAL_WORKING_DAYS,

NVL(WEEKLY_HOLIDAY,0)+NVL(GOV_HOLIDAY,0)+NVL(CASUAL_LEAVE,0)+NVL(MEDICAL_LEAVE,0)+NVL(EARN_LEAVE,0)+NVL(OTHERS_LEAVE,0)+
NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0) AS TOTAL_PAYABLE_DAYS,

(CASE 
WHEN TO_CHAR(JOIN_DT,'MM/YYYY') = :P_MNYR THEN
    NVL(NVL(MONTH_DAYS,0)-(TO_NUMBER(TO_CHAR(JOIN_DT,'DD'))-1),0)-(NVL(WEEKLY_HOLIDAY,0)+NVL(GOV_HOLIDAY,0)+NVL(CASUAL_LEAVE,0)+NVL(MEDICAL_LEAVE,0)+NVL(EARN_LEAVE,0)+NVL(OTHERS_LEAVE,0)+
NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0))
WHEN TO_CHAR(EMP_INACTIVE_DT,'MM/YYYY') = :P_MNYR THEN
   	NVL(NVL(MONTH_DAYS,0)-(TO_NUMBER(TO_CHAR(EMP_INACTIVE_DT,'DD'))+1),0)-(NVL(WEEKLY_HOLIDAY,0)+NVL(GOV_HOLIDAY,0)+NVL(CASUAL_LEAVE,0)+NVL(MEDICAL_LEAVE,0)+NVL(EARN_LEAVE,0)+NVL(OTHERS_LEAVE,0)+
NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0))
ELSE
    (NVL(MONTH_DAYS,0) -(NVL(WEEKLY_HOLIDAY,0)+NVL(GOV_HOLIDAY,0)+NVL(CASUAL_LEAVE,0)+NVL(MEDICAL_LEAVE,0)+NVL(EARN_LEAVE,0)+NVL(OTHERS_LEAVE,0)+
NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0)))
END) AS TOTAL_ABSENT,

(CASE WHEN TRUNC(CONFIRM_DT) <= TO_DATE(:P_MNYR,'MM/YYYY') THEN 
   ROUND((NVL(PBASIC_SALARY, 0)*.07),2)
ELSE
	 NULL
END)AS CF_PF,

((NVL(PBASIC_SALARY,0)/208)*2) AS OT_RATE,
(CASE 
WHEN OT_HOUR IS NOT NULL THEN 
  CASE WHEN OT_HOUR <= NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0)*2 THEN
	OT_HOUR
  ELSE 
   (NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0)*2)-1
  END
ELSE
 CASE WHEN NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0)*2 < 52 then
  (NVL(PRESENT_DAYS,0)+NVL(AUTHORIZE_PRESENT,0)*2)-1
 ELSE
	52
 END
END)OT_HOUR,
JOIN_DT,
EMP_INACTIVE_DT,
MONTH_DAYS
FROM (SELECT     
X.EMP_ID,
X.NAME,
(select DESIG_DESC 
  from DESIGNATION
  where
  DEPT_GROUP = X.DEPT_GROUP AND
  DEPT_CODE = X.DEPT_CODE AND
  DESIG_code = X.DESIG_CODE) DESIGNATION,
X.DEPT_DESC SECTION_NAME,
X.JOIN_DT,
( select GRADE 
  from DESIGNATION
  where
  DEPT_GROUP = X.DEPT_GROUP AND
  DEPT_CODE = X.DEPT_CODE AND
  DESIG_code = X.DESIG_CODE) GRADE,
((NVL(X.GROSS_SAL,0)-(X.PMEDICAL_ALL+X.PCONVEYANCE_ALL+X.FOOD_ALL))/1.4) PBASIC_SALARY,
ROUND(((NVL(X.GROSS_SAL,0)-(X.PMEDICAL_ALL+X.PCONVEYANCE_ALL+X.FOOD_ALL))/1.4)*.40) PHOUSE_RENT,
X.PMEDICAL_ALL,
X.PCONVEYANCE_ALL,
X.FOOD_ALL,
X.GROSS_SAL,
(CASE 
WHEN TO_CHAR(X.JOIN_DT,'MM/YYYY') = :P_MNYR THEN
  (SELECT COUNT(*) FROM HOLIDAY_WEEK
  WHERE 
  COMPANY_CODE           = :P_COMPANY_CODE AND
  COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
  TO_CHAR(HOLIDAY_DATE,'MM/YYYY') = :P_MNYR
  AND HOLIDAY_DATE >= X.JOIN_DT
  AND HOLIDAY_DATE NOT IN 
	(SELECT LEAVE_DT
   FROM   LEAVE_APPLICATION_DTL
   WHERE 
   COMPANY_CODE           = :P_COMPANY_CODE AND
   COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   EMP_ID                 = X.EMP_ID AND
   TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR   
  ))
WHEN TO_CHAR(X.EMP_INACTIVE_DT,'MM/YYYY') = :P_MNYR THEN
 (SELECT COUNT(*) FROM HOLIDAY_WEEK
 WHERE 
 COMPANY_CODE           = :P_COMPANY_CODE AND
 COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
 TO_CHAR(HOLIDAY_DATE,'MM/YYYY') =  :P_MNYR
 AND HOLIDAY_DATE <= X.EMP_INACTIVE_DT
 AND HOLIDAY_DATE NOT IN 
	(SELECT LEAVE_DT
   FROM   LEAVE_APPLICATION_DTL
   WHERE 
   COMPANY_CODE           = :P_COMPANY_CODE AND
   COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   EMP_ID                 = X.EMP_ID AND
   TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR   
   ))  
ELSE
 (SELECT COUNT(*) FROM HOLIDAY_WEEK
 WHERE 
 COMPANY_CODE           = :P_COMPANY_CODE AND
 COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
 TO_CHAR(HOLIDAY_DATE,'MM/YYYY') = :P_MNYR
 AND HOLIDAY_DATE NOT IN 
	(SELECT LEAVE_DT
   FROM   LEAVE_APPLICATION_DTL
   WHERE 
   COMPANY_CODE           = :P_COMPANY_CODE AND
   COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   EMP_ID                 = X.EMP_ID AND
   TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR   
   ))
END) AS WEEKLY_HOLIDAY,

(CASE
WHEN TO_CHAR(X.JOIN_DT,'MM/YYYY') =  :P_MNYR THEN
	(SELECT COUNT(*)FROM HOLIDAY
	WHERE 
	COMPANY_CODE           = :P_COMPANY_CODE AND
    COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
    TO_CHAR(DATE_TO,'MM/YYYY') = :P_MNYR
	AND FROM_DATE >= X.JOIN_DT
	AND FROM_DATE NOT IN 
			(
			SELECT HOLIDAY_DATE
			FROM HOLIDAY_WEEK
			WHERE 
			COMPANY_CODE           = :P_COMPANY_CODE AND
    		COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
    		TO_CHAR(HOLIDAY_DATE,'MM/YYYY') = :P_MNYR
			UNION
			SELECT LEAVE_DT
   			FROM   LEAVE_APPLICATION_DTL
   			WHERE 
   			COMPANY_CODE           = :P_COMPANY_CODE AND
   			COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   			EMP_ID                 = X.EMP_ID AND
   			TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR
	))

WHEN TO_CHAR(X.EMP_INACTIVE_DT,'MM/YYYY') =  :P_MNYR THEN
			(SELECT COUNT(*) FROM HOLIDAY
			WHERE 
			COMPANY_CODE           = :P_COMPANY_CODE 
  		    AND COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE 
  		    AND TO_CHAR(FROM_DATE,'MM/YYYY') = :P_MNYR 
			AND FROM_DATE <= X.EMP_INACTIVE_DT
			AND FROM_DATE NOT IN 
			(
			SELECT HOLIDAY_DATE
			FROM HOLIDAY_WEEK
			WHERE
    	COMPANY_CODE           = :P_COMPANY_CODE AND
    	COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
    	TO_CHAR(HOLIDAY_DATE,'MM/YYYY')= :P_MNYR
    	UNION
			SELECT LEAVE_DT
   		FROM   LEAVE_APPLICATION_DTL
   		WHERE 
   		COMPANY_CODE           = :P_COMPANY_CODE AND
   		COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   		EMP_ID                 = X.EMP_ID AND
   		TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR
    	))
ELSE
		(SELECT COUNT(*) FROM HOLIDAY
		WHERE 
		COMPANY_CODE           = :P_COMPANY_CODE AND
    	COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
    	TO_CHAR(FROM_DATE,'MM/YYYY') = :P_MNYR
		AND FROM_DATE NOT IN 
			(
			SELECT HOLIDAY_DATE
			FROM HOLIDAY_WEEK
			WHERE 
			COMPANY_CODE           = :P_COMPANY_CODE AND
    	COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
    	TO_CHAR(HOLIDAY_DATE,'MM/YYYY') = :P_MNYR
    	UNION
			SELECT LEAVE_DT
   		FROM   LEAVE_APPLICATION_DTL
   		WHERE 
   		COMPANY_CODE           = :P_COMPANY_CODE AND
   		COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
   		EMP_ID                 = X.EMP_ID AND
   		TO_CHAR(LEAVE_DT,'MM/YYYY')= :P_MNYR
			))
END) AS GOV_HOLIDAY,

(SELECT COUNT(B.LEAVE_DT)LEAVE_DAYS
  FROM LEAVE_APPLICATION A, LEAVE_APPLICATION_DTL B
  WHERE
  A.COMPANY_CODE       =B.COMPANY_CODE AND
  A.COMPANY_BRANCH_CODE=B.COMPANY_BRANCH_CODE AND
  A.EMP_ID             =B.EMP_ID AND
  A.APPLICATION_DT     =B.APPLICATION_DT AND
  A.LEAVE_TYPE_CODE    ='01' AND
  A.EMP_ID             = X.EMP_ID AND
  SUBSTR(TO_CHAR(B.LEAVE_DT,'DD/MM/YYYY'),4,8)=:P_MNYR) AS CASUAL_LEAVE,
  
(SELECT COUNT(B.LEAVE_DT)LEAVE_DAYS
  FROM LEAVE_APPLICATION A, LEAVE_APPLICATION_DTL B
  WHERE
  A.COMPANY_CODE       =B.COMPANY_CODE AND
  A.COMPANY_BRANCH_CODE=B.COMPANY_BRANCH_CODE AND
  A.EMP_ID             =B.EMP_ID AND
  A.APPLICATION_DT     =B.APPLICATION_DT AND
  A.LEAVE_TYPE_CODE  IN ('03') AND
  A.EMP_ID             = X.EMP_ID AND
  SUBSTR(TO_CHAR(B.LEAVE_DT,'DD/MM/YYYY'),4,8)=:P_MNYR) AS EARN_LEAVE,
  
(SELECT COUNT(B.LEAVE_DT)LEAVE_DAYS
  FROM LEAVE_APPLICATION A, LEAVE_APPLICATION_DTL B
  WHERE
  A.COMPANY_CODE       =B.COMPANY_CODE AND
  A.COMPANY_BRANCH_CODE=B.COMPANY_BRANCH_CODE AND
  A.EMP_ID             =B.EMP_ID AND
  A.APPLICATION_DT     =B.APPLICATION_DT AND
  A.LEAVE_TYPE_CODE    ='02' AND
  A.EMP_ID             = X.EMP_ID AND
  SUBSTR(TO_CHAR(B.LEAVE_DT,'DD/MM/YYYY'),4,8)=:P_MNYR) AS MEDICAL_LEAVE,
  
(SELECT COUNT(B.LEAVE_DT)LEAVE_DAYS
  FROM LEAVE_APPLICATION A, LEAVE_APPLICATION_DTL B
  WHERE
  A.COMPANY_CODE       =B.COMPANY_CODE AND
  A.COMPANY_BRANCH_CODE=B.COMPANY_BRANCH_CODE AND
  A.EMP_ID             =B.EMP_ID AND
  A.APPLICATION_DT     =B.APPLICATION_DT AND
  A.LEAVE_TYPE_CODE  IN ('04','05') AND
  A.EMP_ID             = X.EMP_ID AND
  SUBSTR(TO_CHAR(B.LEAVE_DT,'DD/MM/YYYY'),4,8)=:P_MNYR) AS OTHERS_LEAVE,
  
(SELECT COUNT(ATTEND_DATE)
	FROM   DAILY_ATTENDANCE
	WHERE 
        COMPANY_CODE           = :P_COMPANY_CODE AND
        COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE AND
        EMP_ID                 = X.EMP_ID AND
        IN_TIME IS NOT NULL AND
				TO_CHAR(ATTEND_DATE,'MM/YYYY')= :P_MNYR AND
        ATTEND_DATE NOT IN 
				(
			SELECT ATTEND_DATE
			FROM HR_AUTHORIZED_ABSENT_SAL
  			WHERE 
			COMPANY_CODE               = :P_COMPANY_CODE 
			AND COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE
    		AND TO_CHAR(ATTEND_DATE,'MM/YYYY') = :P_MNYR
			AND EMP_ID = X.EMP_ID
			UNION
			SELECT MISCONDUCT_DT
        FROM HR_DISCIPLINARY_ACTION 
        WHERE
        COMPANY_CODE = :P_COMPANY_CODE 
        AND COMPANY_BRANCH_CODE = :P_COMPANY_BRANCH_CODE
        AND EMP_ID = X.EMP_ID
        AND TO_CHAR(MISCONDUCT_DT,'MM/YYYY')= :P_MNYR
				UNION
				SELECT HOLIDAY_DATE
				FROM HOLIDAY_WEEK
				WHERE 
				COMPANY_CODE           = :P_COMPANY_CODE 
        AND COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE
    		AND TO_CHAR(HOLIDAY_DATE,'MM/YYYY') = :P_MNYR
				UNION
				SELECT FROM_DATE
        FROM HOLIDAY
        WHERE
        COMPANY_CODE           = :P_COMPANY_CODE 
        AND COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE
    		AND TO_CHAR(FROM_DATE,'MM/YYYY') = :P_MNYR      
        UNION 
        SELECT L.LEAVE_DT
    		FROM LEAVE_APPLICATION B, LEAVE_APPLICATION_DTL L
    		WHERE
    		B.COMPANY_CODE = L.COMPANY_CODE 
    		AND B.COMPANY_BRANCH_CODE = L.COMPANY_BRANCH_CODE
    		AND B.EMP_ID = L.EMP_ID
    		AND B.APPLICATION_DT = L.APPLICATION_DT
    		AND B.EMP_ID = X.EMP_ID
    		AND B.COMPANY_CODE           = :P_COMPANY_CODE 
        AND B.COMPANY_BRANCH_CODE    = :P_COMPANY_BRANCH_CODE
    		AND TO_CHAR(L.LEAVE_DT,'MM/YYYY')= :P_MNYR    
)) AS PRESENT_DAYS,
GET_AUTHORIZE_PRESENT(:P_COMPANY_CODE,:P_COMPANY_BRANCH_CODE, X.EMP_ID, :P_MNYR) as AUTHORIZE_PRESENT, 
GET_OT_HOUR (:P_COMPANY_CODE,:P_COMPANY_BRANCH_CODE, X.EMP_ID, X.DEPT_GROUP, X.DEPT_CODE,:P_MNYR) as OT_HOUR, 
X.MONTH_DAYS,
X.CONFIRM_DT,
X.EMP_INACTIVE_DT
FROM (SELECT
(last_day(to_date('01/'||:P_MNYR,'DD/MM/YYYY'))-to_date('01/'||:P_MNYR,'DD/MM/YYYY')+1) MONTH_DAYS,                  
A.EMP_ID,
B.DEPT_GROUP,
B.CONFIRM_DT,
B.DESIG_CODE,
B.SALGRADE,
250 PMEDICAL_ALL,
200 PCONVEYANCE_ALL,
650 FOOD_ALL,
ROUND(NVL(A.PBASIC_SALARY,0) + NVL(A.PHOUSE_RENT,0) + nvl(A.PMEDICAL_ALL,0)+NVL(A.PCONVEYANCE_ALL,0)+NVL(A.FOOD_ALL,0)) GROSS_SAL,
(B.name)  name,
B.DEPT_CODE  ,
D.dept_desc,
B.JOIN_DT,
B.EMP_INACTIVE_DT
FROM MONTHLY_SALARY A, EMP B, DEPT D, DESIGNATION S, DEPT_GROUP G

WHERE 
A.COMPANY_CODE = B.COMPANY_CODE 
AND A.COMPANY_BRANCH_CODE = B.COMPANY_BRANCH_CODE 
AND A.EMP_ID = B.EMP_ID
AND B.dept_group = S.dept_group 
AND B.dept_code  = S.dept_code
AND B.desig_code = S.desig_code 
AND S.DESIG_GROUP IN ('OS','FW') 
AND S.DESIG_DESC  NOT IN ('Supervisor', 'Incharge', 'Security Guard', 'Security Asst. Supervisor', 'Security in Charge', 'Security Supervisor', 'Helper(TROLLY)', 'Cook', 'Office Asst.', 'Imam', 'Helper(COVER VAN)', 'Dellivery Man','Asst. Incharge')
AND UPPER(S.DESIG_DESC) NOT LIKE '%DRIVER%'
AND B.DEPT_GROUP = G.DEPT_GROUP_CODE
AND B.DEPT_GROUP = D.DEPT_GROUP
AND B.DEPT_CODE    = D.DEPT_CODE  
AND A.COMPANY_CODE                          = :P_COMPANY_CODE
AND A.COMPANY_BRANCH_CODE         = :P_COMPANY_BRANCH_CODE
--AND B.salary_type                                      = 'F'
AND INIT_YR(A.MNYR)                             = INIT_YR(:p_mnyr)
AND (b.dept_group                                     = :p_dept_code or :p_dept_code is null)
AND (b.dept_code                                      = :p_section or :p_section is null)
AND (a.emp_id                                            = :p_emp_id or :p_emp_id is null)
--AND A.EMP_ID = :p_emp_id
AND  A.EMP_ID IN
(SELECT EMP_ID 
 FROM EMP
 WHERE
 (DESIG_CODE, DEPT_CODE, DEPT_GROUP)
 IN 
  (SELECT DESIG_CODE, DEPT_CODE, DEPT_GROUP 
  FROM USER_VS_DESIG 
  WHERE USER_ID=USER)
 )

AND A.EMP_ID  NOT IN 
(
SELECT DISTINCT  P.EMP_ID 
FROM LEAVE_APPLICATION P, LEAVE_APPLICATION_DTL R
WHERE 
P.COMPANY_CODE = R.COMPANY_CODE 
AND P.COMPANY_BRANCH_CODE = R.COMPANY_BRANCH_CODE
AND P.EMP_ID = R.EMP_ID
AND P.APPLICATION_DT = R.APPLICATION_DT
AND P.COMPANY_CODE               = :P_company_code
AND P.COMPANY_BRANCH_CODE  = :P_COMPANY_BRANCH_CODE
AND (P.EMP_ID = :P_EMP_ID OR :P_EMP_ID IS NULL)
AND P.LEAVE_TYPE_CODE = '06'
AND INIT_YR(TO_CHAR(R.LEAVE_DT,'MM/YYYY')) = INIT_YR(:P_MNYR)
)

ORDER BY G.DEPT_GROUP_SL, B.DEPT_GROUP, B.DEPT_CODE, B.DESIG_CODE,B.JOIN_DT, A.EMP_ID) X))
